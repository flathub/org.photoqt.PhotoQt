app-id: org.photoqt.PhotoQt
runtime: org.kde.Platform
runtime-version: '6.10'
sdk: org.kde.Sdk
command: photoqt
finish-args:
    - --share=ipc
    - --share=network
    - --socket=wayland
    - --socket=fallback-x11
    - --filesystem=host
    - --device=dri
    - --socket=pulseaudio
    - --talk-name=org.kde.StatusNotifierWatcher
cleanup:
    - /include
    - /lib/pkgconfig
    - /lib/cmake
    - /share/pkgconfig
    - /share/boost_predef
    - /share/doc
    - /share/man
    - '*.a'
modules:
    ########################
    # EXIV2
    ########################
    - name: exiv2
      buildsystem: cmake-ninja
      builddir: true
      config-opts:
        - -DCMAKE_BUILD_TYPE=Release
        - -DEXIV2_ENABLE_INIH=OFF
        - -DEXIV2_BUILD_SAMPLES=OFF
        - -DEXIV2_BUILD_EXIV2_COMMAND=OFF
        - -DEXIV2_ENABLE_BMFF=ON
      cleanup:
        - /bin
        - /share/man
      sources:
        - type: git
          url: https://github.com/Exiv2/exiv2
          commit: afcb7a8ba84a7de36d2f1ee7689394e078697956
          tag: v0.28.7

    ########################
    # RAW SUPPORT
    ########################
    - name: libraw
      builddir: true
      config-opts:
        - --disable-examples
      sources:
        - type: git
          url: https://github.com/LibRaw/LibRaw
          commit: 0b56545a4f828743f28a4345cdfdd4c49f9f9a2a
          tag: 0.22.0
        - type: shell
          commands:
            - "autoreconf -vfi"

    ########################
    # EXR SUPPORT
    ########################
    - name: libdeflate
      buildsystem: cmake-ninja
      config-opts:
        - -DCMAKE_BUILD_TYPE=Release
      sources:
        - type: git
          url: https://github.com/ebiggers/libdeflate
          commit: c8c56a20f8f621e6a966b716b31f1dedab6a41e3
          tag: v1.25
    ########################
    - name: imath
      buildsystem: cmake-ninja
      config-opts:
        - -DCMAKE_BUILD_TYPE=Release
      sources:
        - type: git
          url: https://github.com/AcademySoftwareFoundation/Imath
          commit: 1e480d11cb98b032a2dece9b9a8730512effc7f6
          tag: v3.2.2
    ########################
    - name: openjph
      buildsystem: cmake-ninja
      config-opts:
        - -DCMAKE_BUILD_TYPE=Release
        - -DOJPH_BUILD_EXECUTABLES=OFF
      sources:
        - type: git
          url: https://github.com/aous72/OpenJPH
          commit: 4d4f4e8b7f00d877d6a615a991b48ad08a640990
          tag: 0.26.0
    ########################
    - name: openexr
      buildsystem: cmake-ninja
      config-opts:
        - -DCMAKE_BUILD_TYPE=Release
      sources:
        - type: git
          url: https://github.com/AcademySoftwareFoundation/openexr
          commit: 741ecb82ccdb291ce5b04713fc6c03208753575e
          tag: v3.4.4

    ########################
    # POPPLER DOCUMENTS
    ########################
    - name: poppler-data
      buildsystem: cmake-ninja
      builddir: true
      config-opts:
        - -DCMAKE_BUILD_TYPE=Release
      sources:
        - type: git
          url: https://gitlab.freedesktop.org/poppler/poppler-data
          commit: af9f452b427d5ce8abe81ff98cc40c5f39fad90b
          tag: POPPLER_DATA_0_4_12
    ########################
    - name: boost
      buildsystem: simple
      cleanup:
        - "libboost*.so*"
      build-commands:
        - ./bootstrap.sh --with-libraries=container
        - ./b2 install variant=release link=shared runtime-link=shared --prefix="$FLATPAK_DEST" -j $FLATPAK_BUILDER_N_JOBS
      sources:
        - type: archive
          url: https://archives.boost.io/release/1.90.0/source/boost_1_90_0.tar.gz
          sha256: 5e93d582aff26868d581a52ae78c7d8edf3f3064742c6e77901a1f18a437eea9
    ########################
    - name: poppler
      buildsystem: cmake-ninja
      config-opts:
        - -DCMAKE_BUILD_TYPE=Release
        - -DENABLE_GOBJECT_INTROSPECTION=OFF
        - -DENABLE_LIBOPENJPEG=openjpeg2
        - -DBUILD_GTK_TESTS=OFF
        - -DBUILD_QT5_TESTS=OFF
        - -DBUILD_QT6_TESTS=OFF
        - -DENABLE_QT5=OFF
        - -DENABLE_QT6=ON
        - -DBUILD_CPP_TESTS=OFF
        - -DENABLE_UTILS=ON
        - -DENABLE_BOOST=ON
      sources:
        - type: git
          url: https://gitlab.freedesktop.org/poppler/poppler
          commit: d3c0e9ca648efbca25a32741ebef9386afc53d1d
          tag: poppler-26.01.0

    ########################
    # KDE IMAGE FORMATS
    ########################
    - name: extra-cmake-modules
      buildsystem: cmake-ninja
      cleanup:
        - '*'
      config-opts:
        - -DCMAKE_BUILD_TYPE=Release
        - -DBUILD_TESTING=OFF
      sources:
        - type: git
          url: https://invent.kde.org/frameworks/extra-cmake-modules.git
          commit: 3f76d71045e935ced4723c12345162f16cc8cb21
          tag: v6.22.0
    ########################
    - name: kimageformats
      buildsystem: cmake-ninja
      builddir: true
      config-opts:
        - -DCMAKE_BUILD_TYPE=Release
        - -DBUILD_TESTING=OFF
        - -DKIMAGEFORMATS_HEIF=ON
        - -DKIMAGEFORMATS_JXL=ON
      sources:
        - type: git
          url: https://invent.kde.org/frameworks/kimageformats.git
          commit: 19df8b03a86b24f85c42f1abcef95cb3c0f85c9b
          tag: v6.22.0

    ########################
    # ffmpegthumbnailer
    ########################
    - name: ffmpegthumbnailer
      buildsystem: cmake-ninja
      config-opts:
        - -DCMAKE_BUILD_TYPE=Release
        - -DENABLE_TESTS=OFF
      sources:
        - type: git
          url: https://github.com/dirkvdb/ffmpegthumbnailer
          commit: cfaf0c5018aec14e5ecbb687d40b090c2a6a14bd
          tag: v2.3.0

    ########################
    # MPV SUPPORT
    ########################
    - name: glslang
      buildsystem: cmake-ninja
      config-opts:
        - -DCMAKE_BUILD_TYPE=Release
        - -DGLSLANG_TESTS=OFF
        - -DENABLE_OPT=OFF
      sources:
        - type: git
          url: https://github.com/KhronosGroup/glslang
          commit: b5782e52ee2f7b3e40bb9c80d15b47016e008bc9
          tag: 16.1.0
    ########################
    - name: libplacebo
      buildsystem: meson
      config-opts:
        - -Dtests=false
        - -Dvulkan=enabled
        - -Dglslang=enabled
        - -Dlcms=enabled
        - -Dd3d11=disabled
        - -Ddemos=false
      sources:
        - type: git
          url: https://github.com/haasn/libplacebo
          commit: 3188549fba13bbdf3a5a98de2a38c2e71f04e21e
          tag: v7.351.0
        - type: patch
          path: patches/libplacebo-python-fix.patch
    ########################
    - name: libass
      buildsystem: autotools
      sources:
        - type: git
          url: https://github.com/libass/libass
          commit: bbb3c7f1570a4a021e52683f3fbdf74fe492ae84
          tag: 0.17.4
    ########################
    - name: libmpv
      buildsystem: meson
      config-opts:
        - -Dlibmpv=true
        - -Dcaca=disabled
        - -Dcdda=disabled
        - -Ddvbin=disabled
        - -Ddvdnav=disabled
        - -Dlibarchive=disabled
        - -Dopenal=disabled
      sources:
        - type: git
          url: https://github.com/mpv-player/mpv
          commit: 41f6a645068483470267271e1d09966ca3b9f413
          tag: v0.41.0

    ########################
    # MAGICK HAPPENS HERE
    ########################
    - name: ghostscript
      build-options:
        cflags: -std=gnu18
      config-opts:
        - --enable-shared
        - --disable-static
      sources:
        - type: archive
          url: https://github.com/ArtifexSoftware/ghostpdl-downloads/releases/download/gs10060/ghostscript-10.06.0.tar.gz
          sha256: 5bd6da34794928cc7e616f288e32bd0be7f9a5ca2d3c206a0af2c19a4e3a318f
    ########################
    - name: imagemagick
      builddir: true
      config-opts:
        - --enable-shared
        - --disable-static
        - --disable-docs
        - --with-modules
        - --with-threads
        - --with-png
        - --enable-hdri
        - --enable-opencl
        - --with-djvu
        - --with-fftw
        - --with-jxl
        - --with-lqr
        - --with-modules
        - --with-openexr
        - --with-openjp2
        - --with-rsvg
        - --with-webp
        - --with-wmf
        - --with-xml
        - --with-dps
        - --with-fpx
        - --with-gvc
      sources:
        - type: git
          url: https://github.com/ImageMagick/ImageMagick
          commit: bdd4fa561d7bf4c6afd40ee9c89e9f9e82b6e88b
          tag: 7.1.2-12
        - type: patch
          path: patches/imagemagick_7.1.2-12.patch

    ########################
    # ZXING-CPP
    ########################
    - name: zxing-cpp
      buildsystem: cmake-ninja
      config-opts:
        - -DCMAKE_BUILD_TYPE=Release
        - -DBUILD_WRITERS=OFF
        - -DBUILD_EXAMPLES=OFF
      sources:
        - type: git
          url: https://github.com/zxing-cpp/zxing-cpp
          commit: d6068bcebeb8fd9f0d35a99b00d202be86a14dbe
          tag: v2.3.0

    ########################
    # LIBSAI
    ########################
    - name: libsai
      buildsystem: cmake-ninja
      config-opts:
        - -DCMAKE_BUILD_TYPE=Release
        - -DBUILD_SHARED_LIBS=ON
      sources:
        - type: git
          url: https://github.com/Wunkolo/libsai
          commit: df66c163b92466e650f17eb3a870670e04f5b264


    ########################
    # EXTENSIONS
    ########################
    - name: yaml-cpp
      buildsystem: cmake-ninja
      builddir: true
      sources:
        - type: git
          url: https://github.com/jbeder/yaml-cpp
          commit: f7320141120f720aecc4c32be25586e7da9eb978
          tag: 0.8.0
        - type: patch
          path: patches/yaml-cpp-fix-cmake-version.patch
        - type: patch
          path: patches/yaml-cpp-fix-uint16.patch
    - name: qca
      buildsystem: cmake-ninja
      builddir: true
      config-opts:
        - -DENABLE_TESTING=OFF
        - -DBUILD_WITH_QT6=ON
      sources:
        - type: git
          url: https://invent.kde.org/libraries/qca.git
          commit: df5171e3c4baf346581f15af5a040e61b166a332
          tag: v2.3.10
    - name: photoqt-extensions
      buildsystem: cmake-ninja
      builddir: true
      config-opts:
        - -DWITH_IMAGEMAGICK=ON
        - -DWITH_GRAPHICSMAGICK=OFF
        - -DWITH_EXIV2=ON
        - -DCMAKE_INSTALL_PREFIX=/app/lib/PhotoQt/extensions
      sources:
        - type: git
          url: https://gitlab.com/lspies/photoqt-extensions.git
          commit: 926f951b61083d1bc78c38664e1498b251f6d16c
          tag: v5.1

    ########################
    ########################
    - name: photoqt
      buildsystem: cmake-ninja
      builddir: true
      config-opts:
        - -DWITH_IMAGEMAGICK=ON
        - -DWITH_GRAPHICSMAGICK=OFF
        - -DWITH_EXIV2=ON
        - -DWITH_LIBARCHIVE=ON
        - -DWITH_LIBRAW=ON
        - -DWITH_POPPLER=ON
        - -DWITH_QTPDF=OFF
        - -DWITH_DEVIL=OFF
        - -DWITH_FREEIMAGE=OFF
        - -DWITH_PUGIXML=OFF
        - -DWITH_CHROMECAST=OFF
        - -DWITH_LIBVIPS=OFF
        - -DWITH_VIDEO_MPV=ON
        - -DWITH_EXIV2_ENABLE_BMFF=ON
        - -DWITH_ZXING=ON
        - -DWITH_FLATPAKBUILD=ON
        - -DWITH_WAYLANDSPECIFIC=ON
        - -DWITH_EXTENSIONS_SUPPORT=ON
        - -DWITH_LIBSAI=ON
      sources:
        - type: git
          url: https://gitlab.com/lspies/photoqt.git
          commit: 43166e86df24ec460d83f2b573e86044e75bf29e
          tag: v5.1
